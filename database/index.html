
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../dbinstance/">
      
      
        
      
      
      <link rel="icon" href="../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Database - DB Operator</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#database" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="DB Operator" class="md-header__button md-logo" aria-label="DB Operator" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DB Operator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Database
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="DB Operator" class="md-nav__button md-logo" aria-label="DB Operator" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    DB Operator
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Database
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Database
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-create-and-use-a-database" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to create and use a database
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generic-additional-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generic additional options
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generic additional options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deletion-protection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deletion Protection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#credentials-templates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Credentials Templates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extra-grants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Extra Grants
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extra-labels-and-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Extra Labels and Annotations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-postgresql-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional PostgreSQL options
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reusing-an-existing-secret" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reusing an existing secret
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experimental-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Experimental features
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Experimental features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rds-iam-impersonate" class="md-nav__link">
    <span class="md-ellipsis">
      
        RDS IAM Impersonate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#force-database-deletion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Force Database Deletion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconciliation-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reconciliation logic
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dbinstance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DbInstance
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dbuser/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DbUser
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../install_helm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install with Helm
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Templates
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/contribution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to contribute
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/helm-charts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Helm Chart development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-create-and-use-a-database" class="md-nav__link">
    <span class="md-ellipsis">
      
        How to create and use a database
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generic-additional-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generic additional options
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generic additional options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deletion-protection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deletion Protection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#credentials-templates" class="md-nav__link">
    <span class="md-ellipsis">
      
        Credentials Templates
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extra-grants" class="md-nav__link">
    <span class="md-ellipsis">
      
        Extra Grants
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extra-labels-and-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Extra Labels and Annotations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-postgresql-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional PostgreSQL options
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reusing-an-existing-secret" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reusing an existing secret
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experimental-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Experimental features
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Experimental features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rds-iam-impersonate" class="md-nav__link">
    <span class="md-ellipsis">
      
        RDS IAM Impersonate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#force-database-deletion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Force Database Deletion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconciliation-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reconciliation logic
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="database">Database</h1>
<p><strong>Database</strong> might be considered the most important resource in the operator. It should be used to manage the lifecycle of databases and a users associated with them on the server.</p>
<h2 id="how-to-create-and-use-a-database">How to create and use a database</h2>
<p>To create a <code>Database</code>, you first would need to have a running <code>DbInstance</code>. You can read about the <code>DbInstances</code> <a href="../dbinstance/">here</a>.</p>
<p>After you have a working <code>DbInstance</code> you can start creating a database.</p>
<p>Let's start by defining an instance on which the database should be deployed. Let's assume you have an instance called <code>cloudnative-pg</code></p>
<pre><code class="language-yaml">apiVersion: kinda.rocks/v1beta1
kind: Database
metadata:
  name: my-database
spec:
  instance: cloudnative-pg
</code></pre>
<p>Then we need to define a name that is going to be used by the operator to create a <code>ConfigMap</code> and a <code>Secret</code>. If a secret with this name already exists, db-operator will try to use it, but let's talk about it <a href="#reusing-an-existing-secret">later</a>.</p>
<pre><code class="language-yaml">apiVersion: kinda.rocks/v1beta1
kind: Database
metadata:
  name: my-database
spec:
    instance: cloudnative-pg
    secretName: my-database-creds
</code></pre>
<p>And this is already enough to start using a database, after applying this manifest, operator will create a database and a user on a server, assign required permissions, and create a Secret and a ConfigMap in Kubernetes. Let's check</p>
<pre><code class="language-sh">$ kubectl get db my-database
NAME          STATUS   PROTECTED   DBINSTANCE         OPERATORVERSION       AGE
my-database   true     false       cloudnative-pg   2.19.0                3m33s

$ kubectl get secret my-database-creds
NAME                TYPE     DATA   AGE
my-database-creds   Opaque   4      4m44s

$ kubectl get cm my-database-creds
NAME                DATA   AGE
my-database-creds   4      4m46s
</code></pre>
<p>The Secret should contain credentials to connect to the database generated by operator.</p>
<p>For <strong>PostgreSQL</strong>:</p>
<pre><code class="language-YAML">apiVersion: v1
kind: Secret
metadata:
  labels:
    app.kubernetes.io/managed-by: db-operator
    kinda.rocks/used-by-kind: Database
    kinda.rocks/used-by-name: my-database
  name: my-database-creds
type: Opaque
data:
  POSTGRES_DB: &lt;&lt; base64 encoded database name (generated by db operator) &gt;&gt;
  POSTGRES_PASSWORD: &lt;&lt; base64 encoded password (generated by db operator) &gt;&gt;
  POSTGRES_USER: &lt;&lt; base64 encoded user name (generated by db operator) &gt;&gt;
  CONNECTION_STRING: &lt;&lt; base64 encoded database connection string &gt;&gt;
</code></pre>
<p>For <strong>MySQL</strong>:</p>
<pre><code class="language-YAML">apiVersion: v1
kind: Secret
metadata:
  labels:
    app.kubernetes.io/managed-by: db-operator
    kinda.rocks/used-by-kind: Database
    kinda.rocks/used-by-name: my-database
  name: my-database-creds
type: Opaque
data:
  DB: &lt;&lt; base64 encoded database name (generated by db operator) &gt;&gt;
  PASSWORD: &lt;&lt; base64 encoded password (generated by db operator) &gt;&gt;
  USER: &lt;&lt; base64 encoded user name (generated by db operator) &gt;&gt;
  CONNECTION_STRING: &lt;&lt; base64 encoded database connection string &gt;&gt;
</code></pre>
<p>And the ConfigMap should contain connection information for database server access.</p>
<pre><code class="language-YAML">apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/managed-by: db-operator
    kinda.rocks/used-by-kind: Database
    kinda.rocks/used-by-name: my-database
  name: my-database-creds
data:
  DB_CONN: &lt;&lt; database server address &gt;&gt;
  DB_PORT: &lt;&lt; database server port &gt;&gt;
  DB_PUBLIC_IP: &lt;&lt; database server public ip &gt;&gt;
  ...
</code></pre>
<p>By default, ConfigMap and Secret are created without owner references, so they won't be removed once the <code>Database</code> resource is removed. If you want them to be deleted too, you need to turn on the cleanup feature.</p>
<pre><code class="language-YAML">apiVersion: &quot;kinda.rocks/v1beta1&quot;
kind: &quot;Database&quot;
metadata:
  name: &quot;example-db&quot;
spec:
  cleanup: true
</code></pre>
<p>If ArgoCD is used to manage Databases and the <code>cleanup</code> is set to <code>true</code>, please make sure that the <code>PrunePropagationPolicy</code> is not set to <code>foreground</code>, because db-operator is using secrets to understand which Database must be removed, and with the <code>foreground</code> policy the secret is removed before the Database, that makes it impossible for the operator to finish the reconciliation.</p>
<p>If this feature is enabled, then <code>Database</code> becomes an owner of Secrets and ConfigMaps, and by removing a database, you'll also remove them.</p>
<p>With the Secret and the ConfigMap, we can connect to the database. Let's create a PostgreSQL Pod to test the connection.</p>
<pre><code>apiVersion: v1
kind: Pod
metadata:
  name: my-app
spec:
  containers:
  - name: postgres-create-table
    image: postgres
    command:
      - psql
    args:
      - -c
      - &quot;CREATE TABLE array_int (vector  int[][]);&quot;
    env:
      - name: PGPASSWORD
        valueFrom:
          secretKeyRef:
            name: my-database-creds
            key: POSTGRES_PASSWORD
      - name: PGUSER
        valueFrom:
          secretKeyRef:
            name: my-database-creds
            key: POSTGRES_USER
      - name: PGDATABASE
        valueFrom:
          secretKeyRef:
            name: my-database-creds
            key: POSTGRES_DB
      - name: PGHOST
        valueFrom:
          configMapKeyRef:
            name: my-database-creds
            key: DB_CONN
    imagePullPolicy: IfNotPresent
  restartPolicy: Never
</code></pre>
<h2 id="generic-additional-options">Generic additional options</h2>
<h3 id="deletion-protection">Deletion Protection</h3>
<p>For production databases you might want to set <code>.spec.deletionProtected</code> to <code>true</code>. With this setting, db-operator will not remove the database from the server, if a Kubernetes resource is deleted.</p>
<h3 id="credentials-templates">Credentials Templates</h3>
<p>DB operator is capable of generating custom connections strings using the information it has about a database, <a href="../templates/">here</a> you can read more about templates.</p>
<h3 id="extra-grants">Extra Grants</h3>
<p>It is possible to apply extra grants to databases, when it's enabled on the db-instance level.
To enable it, one must set <code>.spec.allowExtraGrants</code> to <code>true</code> on an instance.</p>
<p>We have two types of access defined in the code:
    - readOnly
    - readWrite</p>
<p>It reflects the <code>DbUser</code> types of access.</p>
<p>The idea behind the extra grants is that there might be a database user that must have access to certain databases, that is not necessarily managed by the operator. Let's say the user is called <code>database-admin</code>.</p>
<p>Now for whatever reason, we want to let the admin access a database with readOnly permissions. In the db definition we need to add the following:</p>
<pre><code class="language-yaml">kind: Database
spec:
  extraGrants:
    - user: database-admin
      accessType: readOnly
</code></pre>
<p>Now the <code>database-admin</code> should have enough permissions for reading data from this database. If access needs to be revoked or changed to <code>readWrite</code>, it should be enough to remove the entry from the spec or modify it.</p>
<h3 id="extra-labels-and-annotations">Extra Labels and Annotations</h3>
<p>With <code>credentials.metadata.extraLabels</code> and <code>credentials.metadata.extraAnnotations</code> you can add custom metadata to the <strong>Secret</strong> that stores the generated user credentials. These values are merged with the metadata created by the operator. Keys defined in <code>extraLabels</code> or <code>extraAnnotations</code> overwrite existing values with the same key.</p>
<p>Example:</p>
<pre><code class="language-yaml">spec:
  credentials:
    metadata:
      extraLabels:
        environment: development
      extraAnnotations:
        reflector.v1.k8s.emberstack.com/reflection-allowed: &quot;true&quot;
        reflector.v1.k8s.emberstack.com/reflection-auto-enabled: &quot;true&quot;
        reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: target-namespace
</code></pre>
<p>This metadata can be used by external controllers that watch annotations or require specific labels to enable Secret synchronization or reflection across namespaces.</p>
<h2 id="additional-postgresql-options">Additional PostgreSQL options</h2>
<p>PostgreSQL database can be additionally configured using the <code>.spec.postgres{}</code> section.</p>
<p>It's possible to drop ensure that the <strong>public</strong> schema is dropped by setting <code>.spec.postgres.dropPublicSchema</code>, and you can also create additional schemas that will be granted to the database user, managed by the operator, to do so, set the <code>.spec.postgres.schemas[]</code></p>
<pre><code class="language-YAML">postgres:
  dropPublicSchema: true # Do not set it, or set to false if you don't want to drop the public schema
  schemas: # The user that's going to be created by db-operator, will be granted all privileges on these schemas
    - schema_1
    - schema_2
</code></pre>
<p>If you initialize a database with <code>dropPublicSchema: false</code> and then later change it to <code>true</code>, or add schemas with the <code>schemas</code> field and later try to remove them by updating the manifest, you may be unable to do that. Because <code>db-operator</code> won't use <code>DROP CASCADE</code> for removing schemas, and if there are objects depending on a schema, someone with admin access will have to remove these objects manually.</p>
<p>There is a support for <a href="https://www.postgresql.org/docs/current/manage-ag-templatedbs.html">Postgres Database Templates</a>. To create a database from template, you need to set <code>.spec.postgres.template</code>. It's referencing to a database on the Postgres server, but not to the k8s Database resource that is created by operator, so there is no validation on the db-operator side that a template exists.</p>
<h2 id="reusing-an-existing-secret">Reusing an existing secret</h2>
<p>It's possible to connect DB Operator to an existing database. To do so you'll need to point the operator to an existing secret. Itâ€™s important that the secret follows the format expected by the operator.</p>
<p>For postgres:</p>
<pre><code class="language-YAML">POSTGRES_DB: &lt;&lt; base64 encoded database name (generated by db operator) &gt;&gt;
POSTGRES_PASSWORD: &lt;&lt; base64 encoded password (generated by db operator) &gt;&gt;
POSTGRES_USER: &lt;&lt; base64 encoded user name (generated by db operator) &gt;&gt;
</code></pre>
<p>For mysql:</p>
<pre><code class="language-YAML">DB: &lt;&lt; base64 encoded database name (generated by db operator) &gt;&gt;
PASSWORD: &lt;&lt; base64 encoded password (generated by db operator) &gt;&gt;
USER: &lt;&lt; base64 encoded user name (generated by db operator) &gt;&gt;
</code></pre>
<p>Then DB Operator will connect to an existing database and set up a user for it.</p>
<h2 id="experimental-features">Experimental features</h2>
<p>Experimental features are added via annotations, the following features are available for <code>Databases</code></p>
<h3 id="rds-iam-impersonate">RDS IAM Impersonate</h3>
<p>This annotation should be used, when a DbUser is not allowed to log in with password, should be used on the RDS instances, when the SSO is used for authentication.</p>
<p>For more info see this issue: https://github.com/db-operator/db-operator/issues/125</p>
<pre><code class="language-yaml">kinda.rocks/rds-iam-impersonate: &quot;true&quot;
</code></pre>
<h3 id="force-database-deletion">Force Database Deletion</h3>
<p>Delete a postgres database with present connections, might be useful when pgbouncer is used</p>
<pre><code class="language-yaml">kinda.rocks/postgres-force-delete-db: &quot;true&quot;
</code></pre>
<h2 id="reconciliation-logic">Reconciliation logic</h2>
<p>By default db-operator checks if a database needs to be reconcilied.</p>
<p>First, use can force a full reconciliation by setting a following annotation:</p>
<pre><code class="language-yaml">kinda.rocks/db-force-full-reconcile: &quot;true&quot;
</code></pre>
<p>If it's set, operator will remove it and run the full reconciliation.</p>
<p>Then it checks if it's running in a mode, where it should not check changes and each resource should be fully reconcilied on each loop. Actually, by default it doesn't check and always reconciles databases, but to enable this mode, you need to run the operator with the <code>--check-for-changes</code> argument. It might be useful when you have a lot of databases, and updating each one of them might take a very long time.</p>
<p>If you do check for changes, the operator will first check the status of a database and a secret that is used for creating a user. If the status is <code>false</code>, or the secret was changed, it will also trigger reconciliation.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>